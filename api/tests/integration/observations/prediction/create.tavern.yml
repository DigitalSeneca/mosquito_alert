---

test_name: Create is not allowed for mobile users and non auth

includes:
  - !include schema.yml

marks:
  - usefixtures:
    - api_live_url
    - endpoint
    - token_user
    - app_user_token

stages:
  - name: Create method not allowed for mobile users
    request:
      url: "{api_live_url}/{endpoint}/"
      headers:
        Authorization: "Bearer {app_user_token}"
      method: "POST"
    response:
      status_code: 403
  - name: Create method non authenticated users
    request:
      url: "{api_live_url}/{endpoint}/"
      method: "POST"
    response:
      status_code: 403
  - name: Create method authenticated users without permissions
    request:
      url: "{api_live_url}/{endpoint}/"
      headers:
        Authorization: "Token {token_user}"
      method: "POST"
    response:
      status_code: 403

---

test_name: Create method return 400 if reference photo has empty prediction

includes:
  - !include schema.yml

marks:
  - usefixtures:
    - api_live_url
    - endpoint
    - published_observation_with_photo
    - published_observation_photo
    - token_user_can_add

stages:
  - name: Create method
    request:
      url: "{api_live_url}/{endpoint}/"
      headers:
        Authorization: "Token {token_user_can_add}"
      method: "POST"
      json:
        ref_photo_uuid: "{published_observation_photo.uuid}"
        is_executive_validation: false
    response:
      status_code: 400

---

test_name: Create method

includes:
  - !include schema.yml

marks:
  - usefixtures:
    - api_live_url
    - endpoint
    - published_observation_with_photo
    - published_observation_photo_with_prediction
    - token_user_can_add
  - parametrize:
      key: is_executive_validation
      vals:
        - true
        - false

stages:
  - name: Create method
    request:
      url: "{api_live_url}/{endpoint}/"
      headers:
        Authorization: "Token {token_user_can_add}"
      method: "POST"
      json: &request_data
        ref_photo_uuid: "{published_observation_photo_with_prediction.uuid}"
        is_executive_validation: !force_format_include "{is_executive_validation}"
    response:
      status_code: 201
      json:
        <<: *request_data
        insect_confidence: !anyfloat
        predicted_class: !anystr
        predicted_class_display: !anystr
        created_at: !re_fullmatch \d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{6}Z
        updated_at: !re_fullmatch \d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{6}Z